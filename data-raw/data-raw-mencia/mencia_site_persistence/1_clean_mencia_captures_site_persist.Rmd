---
title: "Clean raw Mencia pasture succession data"
author: "brouwern@gmail.com"
date: "February 16, 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## General Workflow

Data was recieved from Steve Latta as seperate spreadsheets which were merge into a single .csv file in 0_proofing_merging....Rmd script

This script tidies/cleans up the data.

The following script makes final changes to prepare for analysis


## General Description of what this script does

See 0_proofing_merging....Rmd for more details

### SCRIPT 1: reshaping, tidying, and cleaning data
The following steps aren't necessarily all distinct in practice or necessarily occur in this precise order

#### Step 1.1: "reshaping" and "tidying"

##### "reshape"
taking data from the format it was entered in into the format that works best w/ R; usually reshaping from "wide" to "long" format.  eg, with data from each subplot in a different column to all data in a single column with subplot number indicated in a desperate column.

##### "tidying"
converting into an analysis-read format.  For example, splitting things like columns that combine treatment and plot number into separate columns.  (treatment column, subplot column)

#### Step 1.2: "cleaning"
Taking reshaped data and fixing any issues just as typos, incorrect column names, data entered into wrong field, fixing species names, etc.

After cleaning and tidying, the data could be "reshaped" (or recast) back into its original format and there would still be an ~1:1 correspondence with the datasheet.


## Libraries
```{r}
library(here)
library(reshape2)
library(stringr)
library(stringi)
```



## Load data

### libraries
```{r}
library(here)
```


### Set up working directories 

Use here::here()

```{r}
here()

file.path <- here()
```


### File loading function
clunky but works
```{r}
filename <- "mencia_all_b.csv"
filename <- here("data-raw",
                  "data-raw-mencia",
                  "mencia_site_persistence",
                  "CSV_mencia_site_persistence",
                 filename)
print(filename)
dat <- read.csv(file = filename,skip = skip,
                header =TRUE,
                strip.white = TRUE,
                blank.lines.skip = TRUE,
                na.strings = c("NA",""," "),
                stringsAsFactors = FALSE,
                colClasses=c("SUF"="character")
                )


```


```{r}
head(dat)
tail(dat)
```


```{r}
summary(dat)
```


### Check data


#### Check head and tail

Number blank columns to rigth and below spreadsheet
```{r}
head(dat); tail(dat)

```


#### Check summary
```{r}
summary(dat)

```



#### Check dim()

```{r}
dim(dat)

```

#### Change all headings to lower case

```{r}
names(dat) <- tolower(names(dat))
```



#### Reconcile names w/ other dataset

```{r}
names(dat[1:10])
names(dat) <- gsub("pre","band.pre",names(dat))
names(dat) <- gsub("suf","band.pre",names(dat))
```






#### Add  year column
```{r}
dat$year.cap <- NA
dat$year.cap[grep("-03",dat$date)] <- 2003
dat$year.cap[grep("-04",dat$date)] <- 2004
dat$year.cap[grep("-05",dat$date)] <- 2005
dat$year.cap[grep("-06",dat$date)] <- 2006
dat$year.cap[grep("-07",dat$date)] <- 2007
dat$year.cap[grep("-08",dat$date)] <- 2008
```



### Remve any NAs

```{r}
dim(mencia[is.na(mencia$site), ])

mencia <- mencia[-which(is.na(mencia$site) == TRUE), ]
```


### Numbers in notes column are beak lengths

Used for sexing

```{r}
mencia$beak <- gsub("[a-zA-Z]","",mencia$notes)
mencia$beak <- as.numeric(mencia$beak)
summary(mencia$beak)
```


### Convert to factors

```{r}
mencia$band.pre <- factor(mencia$band.pre)
mencia$band.suf <- factor(mencia$band.suf)
mencia$colors <- factor(mencia$colors)
mencia$age <- factor(mencia$age)
mencia$year <- factor(mencia$year)
```



### Check out data
```{r}
summary(mencia)
```

```{r}
summary(factor(mencia$fat),1000)
```

```{r}
summary(factor(mencia$sex),1000)
```


```{r}
summary(factor(mencia$notes),1000)
```


### Dates

Not formatted

```{r}

```



## Sites

Some years sites have "A" label; remove

```{r}
with(mencia, table(year, site))

mencia$site <- factor(gsub("[ ][A]$","",mencia$site ))
```



### Fix typos

```{r}
mencia$colors <- factor(gsub("x-","X-",as.character(mencia$colors)))

mencia$species <- factor(gsub("AM-KE","AMKE",as.character(mencia$species)))


mencia$sex <- factor(ifelse(mencia$sex == "U", NA,mencia$sex))
```



## Species in study

Need to check species codes to make sure they are current and no typos.

```{r}
library(reshape2)
library(ggplot2)
library(ggpubr)
spp.count <- dcast(data = mencia,
      formula = species ~ .,
      fun.aggregate = length)
names(spp.count) <- c("species","tot.captures")

i.order <- order(spp.count$tot.captures,decreasing = T)
spp.count$species <- factor(spp.count$species,
                            levels = spp.count$species[i.order])

spp.count <- spp.count[i.order,]

#plot
ggbarplot(data = spp.count,
          x = "species", y = "tot.captures") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Save table of species names

```{r}
write.csv(spp.count, file = "temp_spp_codes.csv")
```


```{r}
summary(mencia$species)
```


## Calculate age of sites


```{r}
site.age.tab <- data.frame(site = levels(mencia$site),
                      site.age.init = c(20,5,2,10))

mencia <- merge(mencia,site.age.tab)
  
mencia$site.age <- mencia$site.age.init + 
                      mencia$year.num-2003
```



## Create unique ID

```{r}
mencia$band <- with(mencia, paste(band.pre,
                                  band.suf,
                                  sep = "-"))
```




## Code focal migrants

```{r}
focal.mig <- c("OVEN","BAWW","COYE","AMRE","CMWA",
               "BTBW","PAWA","PRAW")
i <- which(mencia$species %in% focal.mig)

mencia$status <- NA
mencia[i, "status"] <- "mig"
```





## Check for recaps at different ages

Bird could be aged into two diff ages classes; did not occur.  Makes sens b/c most birds not recaptured.  Birds captures as HY often die or move to new site

```{r}
x <- dcast(data= mencia[i.unique,],
      formula = band + species + site ~ age,
      value.var = "age",
      fun.aggregate = length)


timescap <- apply(x[,c("AHY","ASY","HY","SY","NA")],1,sum)
max(timescap)
```



## Save cleaned data

### Save .csv
```{r}
filename <- "mencia_cleaned.csv"
filename <- here("data-raw",
                  "data-raw-mencia",
                  "mencia_all_captures_by_year",
                  filename)

write.csv(mencia, file = filename,row.names = F)
```


```{r}

```

